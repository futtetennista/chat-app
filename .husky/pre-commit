pnpm exec lint-staged

changed_packages=$(git diff --cached --name-only | grep -E '\.tsx?$' | cut -d'/' -f2 | sort -u)
if [ -z "$changed_packages" ]; then
  echo "[pre-commit] Changed packages: none"
else
  echo "[pre-commit] Changed packages: ${changed_packages[*]}"
fi

for package in $changed_packages; do
  if [ -d "packages/$package" ]; then
    echo "[pre-commit] Running tests for package: $package"
    pnpm --filter "$package" run test:unit
  fi
done

git diff --cached --name-only | while read file; do
  set -x
  if [ -f "$file" ]; then
    # Ensure files have ending newline
    if [ "$(tail -c1 "$file")" != "" ]; then
      echo "[pre-commit] Adding newline to $file"
      echo "" >> "$file"
    fi

    # Remove trailing whitespace and add back to staging
    sed -i 's/\s*$//' "$file"
    git add "$file"
  fi
done
